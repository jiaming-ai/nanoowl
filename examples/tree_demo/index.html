<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #main_container {
            text-align: center;
        }

        #logo {
            height: 128px;
        }
        
        #prompt_input {
            width: 100%;
            font-size: 24px;
            margin-top: 16px;
        }

        #camera_image {
            width: 640px;
        }

        #video {
            width: 640px;
            display: block;
        }
    </style>
    <script type="text/javascript">
        window.onload = function() {
    ws = new WebSocket("wss://" + location.host + "/ws");

    ws.onopen = function() {
        console.log("Connected.");
    };

    ws.onclose = function() {
        console.log("Disconnected.");
    };

    ws.onmessage = function(event) {
        var camera_image = document.getElementById("camera_image");
        if (event.data instanceof Blob) {
            console.log("Received Blob of size: " + event.data.size);
            console.log("Received Blob of url: " + URL.createObjectURL(event.data));
            var reader = new FileReader();
            reader.onload = function() {
                console.log("Image data URL: " + reader.result.slice(0, 100) + "...");
                camera_image.src = reader.result;
            };
            reader.onerror = function(error) {
                console.error("Error reading Blob:", error);
            };
            reader.readAsDataURL(event.data);
        } else {
            console.log("Received non-blob message: ", event.data);
        }
    };

    var prompt_input = document.getElementById("prompt_input");
    prompt_input.oninput = function(event) {
        console.log("Sending prompt: " + event.target.value);
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send("prompt:" + event.target.value);
        }
    };

    startCamera();
};

function startCamera() {
    var video = document.getElementById('video');

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
            video.srcObject = stream;
            video.play();
            video.onloadedmetadata = function() {
                captureFrame(video);
            };
        })
        .catch(function(err) {
            console.log("Error: " + err);
        });
}

function captureFrame(video) {
    var canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    var context = canvas.getContext('2d');

    setInterval(function() {
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(function(blob) {
            console.log("Captured Blob of size: " + blob.size);
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(blob);
            }
        }, 'image/jpeg');
    }, 1000); // Capture a frame every second
}
    </script>
</head>
<body>
    <div id="main_container">
        <h1>NanoOWL</h1>
        <video id="video" autoplay></video>
        <img id="camera_image" src="" alt="Camera Image"/>
        <br/>
        <input id="prompt_input" type="text" value="[a cup]" placeholder="[a face [an eye, a nose]]"/>
    </div>
</body>
</html>